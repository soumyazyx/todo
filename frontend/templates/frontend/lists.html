{% load socialaccount %} 
{% providers_media_js %} 
{% load static %}

<!DOCTYPE html>
<html>
  {% include 'frontend/head.html' %}
  <body>
    {% include 'frontend/lists_header.html' %}
    {% if user.is_authenticated %}
    <div class="container">
      <div class="row">
        <div class="col-12">
          <main>
            <div id="form-wrapper">
              <form id="form">
                <div class="flex-wrapper">
                  <br />
                  <div class="input-group mb-3">
                    <input
                      id="title"
                      name="title"
                      type="text"
                      class="form-control"
                      style="border: 1px solid #ccc;"
                      placeholder="New list name"
                    />
                    <div class="input-group-append">
                      <button id="createListBtn" class="btn btn-secondary" type="submit">
                        Create List
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
            <div id="lists-wrapper"></div>
          </main>
        </div>
      </div>
    </div>
    <script>
    </script>
    <script type="text/javascript">
      function showLoader(listid) {
        $("#list-loader-"+listid).removeClass("d-none");
        return true;
      }
    
      $(document).ready(function () {
        var baseurl = window.location.origin;
        var loggedInUsername = $("#logged_in_username").text();
        var csrftoken = getCookie("csrftoken");
        var activeItem = null;
        var listsSnapshot = [];
        

        getUserId();
        buildLists();

        var form = document.getElementById("form-wrapper");
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          console.log("Adding new list..");
          if($.trim($('#title').val()) == ''){
            alert('List name can not be left blank');
            return false;
          }
          $("#createListBtn").html('Creating list <div class="spinner-border spinner-border-sm"></div>')
          var url = baseurl + "/api/list-create/";
          if (activeItem != null) {
            var url = baseurl + `/api/list-update/${activeItem.id}`;
            activeItem = null;
          }
          var title = $("#title").val();
          var user = $("#logged_in_userid").text();
          
          console.log(`URL used: [${url}]`);
          fetch(url, {
            method: "POST",
            headers: {
              "Content-type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({ title: title, users: [user] }),
          }).then(function (response) {
            console.log("Adding new list..Done");
            buildLists();
            document.getElementById("form").reset();
          });
        });

        function editItem(item) {
          activeItem = item;
          document.getElementById("title").value = activeItem.title;
        }

        function deleteItem(item) {
          console.log(`Deleting list with listid = [${item.id}]..`);
          var url = baseurl + `/api/list-delete/${item.id}`;
          fetch(url, {
            method: "DELETE",
            headers: {
              "Content-type": "application/json",
              "X-CSRFToken": csrftoken,
            },
          }).then((response) => {
            console.log(`Deleting list with listid = [${item.id}]..Done`);
            buildLists();
          });
        }

        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
              var cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }

        function getUserId() {
          var url = baseurl + "/api/get-user-id/" + loggedInUsername;
          console.log(`Fetching userid for username [${loggedInUsername}].. `);
          fetch(url)
            .then((resp) => resp.json())
            .then(function (data) {
              console.log(
                `Fetching userid for username [${loggedInUsername}]..Done `
              );
              console.log(`UserID = [${data.id}]`);
              $("#logged_in_userid").text(data.id);
            });
        }


        function buildLists() {
          var url = baseurl + "/api/lists/" + loggedInUsername;
          var wrapper = document.getElementById("lists-wrapper");

          console.log(`Fetching list/s using [${url}]..`);
          fetch(url)
          .then((resp) => resp.json())
          .then(function (data) {
            console.log(`Fetching list/s using [${url}]..Done`);
            $("#loader").hide('slow', function(){ $target.remove(); });
            $("#createListBtn").html('Create List');              
            $("#lists-wrapper").empty();
            var lists = data;
            if (lists.length == 0){
              $("#loader").html('<div class="alert alert-warning" role="alert">It seems a bit lonely here! Create a list to continue</div>');
              $("#loader").show();
            }
            for (var i in lists) {
              var listid = lists[i].id;
              var title = lists[i].title;
              var user = lists[i].user;
              var href = baseurl + `/list/${listid}`;
              var title = `<span class="title">${lists[i].title}</span>`;
              var item = `        
              
              <a
                style="display: block; text-decoration: none;"
                class="shadow-sm p-2 mb-2 bg-white rounded"
                href="${href}"
                id="${listid}"
                onclick="showLoader(${listid}); return true;"
              >
                <span id="data-row-${i}" class="task-wrapper">
                  <span class="text-muted"><i class="fas fa-tasks"></i>&nbsp;&nbsp;&nbsp;</span>
                  <span class="text-muted">
                    ${title}
                    <span class="d-none" id="list-loader-${listid}">
                      <small><span class="spinner-grow spinner-grow-sm fa-xs"></span></small>
                      <small><span class="spinner-grow spinner-grow-sm fa-xs"></span></small>
                      <small><span class="spinner-grow spinner-grow-sm fa-xs"></span></small>
                    </span>
                  </span>
                </span>

                <!-- 
                <span class="btn-group" role="group" aria-label="Basic example" style="float:right">
                <a      style="border:none" class="btn btn-sm btn-outline-info" href=${href}>View</a>
                <button style="border:none" class="btn btn-sm btn-outline-warning edit">Edit</button>
                <button style="border:none" class="btn btn-sm btn-outline-danger delete">Delete</button>                    
                </span>
                -->
              </a>`;
              wrapper.innerHTML += item;
            }
            if (listsSnapshot.length > lists.length) {
              for (var i = lists.length; i < listsSnapshot.length; i++) {
                $(`#data-row-${i}`).remove();
              }
            }
            listSnapshot = lists;
          });
        }

        

      });
    </script>
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    {% endif %}
  </body>
</html>
